# Walk-forward 回测里的 fold（折）到底是什么？（图解）

> 目标：把 **fold / OOS / expanding window** 这些概念用最直观的方式讲清楚。
>
> 适用场景：你现在在 ForecastLab 里做的 **walk-forward（时间滚动）回测**，不是随机 K 折交叉验证。

---

## 1. 先给一句话定义

**fold = 第 k 次“用过去训练、在紧接着的未来做 OOS 测试”的时间切分编号**（从 0 开始）。

- **训练集（train）**：只包含“过去发生过的数据”。
- **OOS（Out-of-Sample）测试集**：紧接训练集之后的一段“未来数据”，用来模拟上线后的真实表现。

---

## 2. 你项目里的切分方式：Expanding Window（扩张窗口）

ForecastLab 当前展示的切分是 **扩张窗口**：

- **训练集开始日期固定**（永远从数据起点开始）
- 每增加一个 fold：
  - 训练集的**结束日期**向后推进（训练集越来越长）
  - OOS 测试窗口整体也向后滚动

---

## 3. 三个关键参数（决定 fold 怎么切）

设：

- `init_train`：第 0 折训练集长度（按“行/天数”）
- `step`：每折向前推进的步长（按“行/天数”）
- `oos_window`：每折 OOS 测试窗口长度（按“行/天数”）

对应到索引（0-based）：

- `train_end_ix = init_train + k * step`
- 训练集索引范围：`[0, train_end_ix - 1]`
- OOS 索引范围：`[train_end_ix, train_end_ix + oos_window - 1]`

> 在你的页面表格里：
> - “训练集开始日期”始终是第 0 行日期
> - “训练集结束日期 / OOS 开始/结束日期”随 fold 变化

---

## 4. 图解：fold=0/1/2 长什么样？

假设我们只画一个抽象时间轴（左=过去，右=未来）：

- `=` 表示训练集
- `|` 表示切分点（train 结束 / OOS 开始）
- `-` 表示 OOS 测试集

### fold = 0

```
时间轴:  [================================|------------------------]
           训练集 init_train               OOS oos_window
```

### fold = 1（训练集向后扩张 step）

```
时间轴:  [====================================|------------------------]
            训练集更长（+ step）                 OOS 向后滚动
```

### fold = 2

```
时间轴:  [========================================|------------------------]
                   训练集继续变长                     OOS 继续向后滚动
```

直观理解：
- fold 越大，训练集“看过的历史”越多
- 每个 fold 的 OOS 都代表一次“上线后在未来区间的表现”

---

## 5. 结合“日期”再解释一次（最重要）

数据按日期升序排列，记全数据起始日期为 `D0`。

对任意 `fold = k`：

- **训练集开始日期** = `D0`（固定）
- **训练集结束日期** = 第 `train_end_ix-1` 行的日期
- **OOS开始日期** = 第 `train_end_ix` 行的日期
- **OOS结束日期** = 第 `train_end_ix+oos_window-1` 行的日期

所以你在 Web 里看到的那张表：

| fold | 训练集开始 | 训练集结束 | OOS开始 | OOS结束 |
|---:|---|---|---|---|
| 0 | 2022-01-01 | … | … | … |
| 1 | 2022-01-01 | 更靠后 | 更靠后 | 更靠后 |
| 2 | 2022-01-01 | 更靠后 | 更靠后 | 更靠后 |

**训练集开始日期都一样**是正常的，因为你用的是 expanding window。

---

## 6. fold 和 “candidate(T/X)” 会不会冲突？

两者是不同维度：

- `fold`：控制时间切分（训练/测试日期范围）
- `candidate(T, X)`：控制标签窗口与阈值（怎么打 -1/0/+1）

理想情况下：
- 同一个 `fold=k` 的 **时间边界**对所有 candidate 一致

但会出现“有效样本数不一样”的现象：
- 因为标签要用未来 `T` 天，靠近区间末尾的样本可能因为未来不够 `T` 天而被 drop 掉
- 所以不同 T 会让每折最终可用样本数量略有区别（这是正常的）

---

## 7. 为什么不用普通 K 折交叉验证？

时间序列不能随便打乱：

- 随机 K 折会让训练集中混入“未来数据”
- 模型会“看见未来”，回测结果虚高

walk-forward 的核心目的就是：

> **永远用过去训练，用未来测试**

---

## 8. Rolling Window（滚动窗口） vs Expanding Window（扩张窗口）

你现在用的是 **Expanding（扩张）**。另一种常见方式是 **Rolling（滚动）**：

### Expanding Window（你现在的）
- 训练集左边界固定在起点
- 越往后训练集越长

### Rolling Window（可选）
- 训练集长度固定
- 每折训练集的开始日期也会向后滚动（窗口整体右移）

图解对比：

**Expanding**
```
[===============|-----]
[===================|-----]
[=======================|-----]
```

**Rolling（训练窗口长度固定）**
```
[   ===========|-----]
[      ===========|-----]
[         ===========|-----]
```

---

## 9. 推荐阅读（关键词）

如果你想找英文/中文资料，建议用下面关键词搜索（更容易找到质量高的文章）：

- “walk-forward validation time series”
- “expanding window vs rolling window”
- “time series cross validation scikit-learn TimeSeriesSplit”
- “purged walk forward cross validation”

> 说明：我这里不直接贴具体链接，避免链接随时间失效；用关键词通常能找到更权威且最新的解读。

---

## 10. 你可以如何对照 ForecastLab 来验证自己理解对不对？

在 Web 的「数据与标签」tab 里：

1) 先选一组 `init_train / step / oos_window`
2) 选择“单折”并切换 `fold=0/1/2/...`
3) 观察表格里：
   - **训练开始日期是否恒定**（应该恒定）
   - **训练结束日期是否递增**（应该递增）
   - **OOS 区间是否整体右移**（应该右移）

如果这些都满足，你对 fold 的理解就已经对了。
